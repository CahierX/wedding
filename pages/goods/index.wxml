<view class="top">
  <t-search class="search" placeholder="搜索" shape="round" value="{{searchKey}}" bind:change="handleSearch" bind:clear="clearSearch" />
  <t-button theme="primary" icon="add-circle" variant="text" capture-bind:tap="openAddGoods" />
</view>
<view>
  <view class="goods">
    <view wx:if="{{goodsList.length>0}}">
      <t-indexes t-class="goods-indexes" index-list="{{indexList}}" sticky="{{false}}">
        <block wx:for="{{goodsList}}" wx:key="index">
          <t-indexes-anchor index="{{item.index}}" />
          <t-cell-group>
            <view wx:for="{{item.children}}" wx:key="id" wx:for-item="goods">
              <t-swipe-cell>
                <view>
                  <t-cell title="{{goods.name}}">
                    <view wx:if="{{mode==='select'}}" class="description" slot="description" data-item="{{goods}}">
                      <t-tag icon="edit-1" variant="outline" data-id="{{goods.id}}" bind:click="openPrice">{{goods[goods.priceType]}}/{{goods.unit}}</t-tag>

                    </view>
                    <view wx:else class="description" slot="description">
                      <text>工厂价:{{goods.factory_price}}/{{goods.unit}};门店价:{{goods.store_price}}/{{goods.unit}}
                      </text>
                    </view>
                    <view class="stepper-slot" slot="note" wx:if="{{mode==='select'}}">
                      <stepper value="{{goods.count}}" uuid="{{goods.id}}" bind:changeGoodsCount="changeGoodsCount" />
                    </view>
                  </t-cell>
                </view>
                <view slot="right" class="btn-wrapper">
                  <view class="swipe-btn edit-btn column" data-item="{{goods}}" bind:tap="onEdit">
                    <t-icon class="padding-bottom" name="edit" size="32rpx"></t-icon>
                    编辑
                  </view>
                  <view class="swipe-btn delete-btn column" data-id="{{goods.id}}" bind:tap="openDelete">
                    <t-icon class="padding-bottom" name="delete" size="32rpx"></t-icon>
                    删除
                  </view>
                </view>
              </t-swipe-cell>
            </view>
          </t-cell-group>
        </block>
      </t-indexes>
    </view>
    <t-empty wx:else description="暂无数据, 点击右上角创建商品" />
  </view>
  <view class="submit-operate" wx:if="{{mode==='select'}}">
    <t-button theme="primary" size="large" block capture-bind:tap="submit">确定</t-button>
  </view>
</view>
<t-popup visible="{{addGoodsVisible}}" prevent-scroll-through="{{true}}" placement="bottom" bind:visible-change="onVisibleChange">
  <view class="popup-block">
    <view class="header">
      <view class="btn btn--cancel" aria-role="button" capture-bind:tap="closeAddGoods">取消</view>
      <view class="title">新增商品</view>
      <view class="btn btn--confirm" aria-role="button" capture-bind:tap="submitAddGoods">确定</view>
    </view>
    <view>
      <t-input wx:for="{{addGoodsMap}}" confirm-hold="{{index!==addCustomerMap.length-1}}" focus="{{index===focusIndex}}" confirm-hold="{{true}}" confirm-type="next" wx:key="value" type="{{item.value==='factory_price' || item.value === 'store_price'? 'digit':'text'}}" label="{{item.label}}" suffix="{{item.value==='factory_price' || item.value === 'store_price'? '元':''}}" align="right" value="{{addGoodsData[item.value]}}" placeholder="请输入{{item.label}}" data-index="{{index}}" data-key="{{item.value}}" bind:change="changeGoodsInput" bind:enter="enter"></t-input>
    </view>
  </view>
</t-popup>
<t-toast id="t-toast" />
<t-dialog visible="{{deleteVisible}}" content="删除后无法恢复,确定删除该商品吗?" confirm-btn="{{ { content: '删除', variant: 'base', theme: 'danger' } }}" cancel-btn="取消" bind:confirm="submitDelete" bind:cancel="closeDelete" />
<t-dialog visible="{{priceVisible}}" confirm-btn="确定" bind:confirm="submitPrice" bind:cancel="closePrice">
  <t-radio-group slot="content" t-class="horizontal-box" value="{{operateGoods.priceType}}" bind:change="onChangePriceType">
    <view wx:for="{{priceMap}}" wx:key="index" class="card {{operateGoods.priceType === item.value ? 'card--active' : ''}} {{item.value=='customPrice'?'custom':''}}">
      <t-icon name="check" t-class="card__icon" />
      <t-radio value="{{item.value}}" label="{{item.name}}({{operateGoods[item.value]}}/{{operateGoods.unit}})" icon="none" borderless>
        <view slot="content" wx:if="{{item.value==='customPrice'}}" class="content-custom">
          <t-input label="金额" t-class-tips="tips" tips="{{priceError?'请输入正确金额':''}}" borderless="{{true}}" placeholder="0.00" suffix="元" align="right" type="digit" value="{{operateGoods.customPrice}}" bind:change="changePartPay" confirm-type="{{index<priceMap.length?'next':'done'}}" bind:enter="enter" />
        </view>
      </t-radio>

    </view>
  </t-radio-group>
</t-dialog>